<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">

    <title>NodeSchool Cleveland - Promise It Won't Hurt</title>

    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="../common/css/reveal.css">
    <link rel="stylesheet" href="../common/css/theme/sky.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="../common/lib/css/zenburn.css">

    <style type="text/css">
        /*.terminal { text-align: left; }
         text editor styles */
        .terminal {
            display: block;
            margin: auto;
            border-radius: 10px;
            box-shadow: rgba(0, 0, 0, 0.8) 0px 20px 70px;
            clear: both;
            overflow: hidden;
            -webkit-transition: all 0.5s ease-out;
            -moz-transition: all 0.5s ease-out;
            -ms-transition: all 0.5s ease-out;
            -o-transition: all 0.5s ease-out;
            transition: all 0.5s ease-out;
        }

        .terminal-title {
            padding: 5px 0 !important;
            font-family: "Lucida Grande", sans-serif !important;
            font-size: 0.75em !important;
            color: black;
            text-align: center;
            text-shadow: rgba(255, 255, 255, 0.8) 0px 1px 0px;
            background-color: #f8f8f8;
            background-image: -webkit-linear-gradient(top, #e8e8e8, #bcbbbc);
            background-image: -moz-linear-gradient(top, #e8e8e8, #bcbbbc);
            background-image: linear-gradient(top, #e8e8e8, #bcbbbc);
            box-shadow: inset rgba(255, 255, 255, 0.7) 0px 1px 1px;
            border-bottom: #6a6a6a 1px solid;
        }

        .terminal-text {
            height: 250px;
            background-color: rgba(0, 0, 0, 0.85);
            padding: 10px;
            color: #f0f0f0;
            text-shadow: #000 0px 1px 0px;
            font-family: "Consolas", "Courier New", "Courier";
            font-size: 1.75em;
            line-height: 1.40em;
            font-weight: 500;
            text-align: left;
            overflow: hidden;
            -webkit-transition: all 0.5s ease-out;
            -moz-transition: all 0.5s ease-out;
            -ms-transition: all 0.5s ease-out;
            -o-transition: all 0.5s ease-out;
            transition: all 0.5s ease-out;
        }

    </style>

    <link rel="stylesheet" href="../common/css/layout.css">
    <link rel="stylesheet" href="styles/styles.css">

    <!-- Printing and PDF exports -->
    <script>
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = window.location.search.match(/print-pdf/gi) ? '../common/css/print/pdf.css' : '../common/css/print/paper.css';
        document.getElementsByTagName('head')[0].appendChild(link);
    </script>

    <!--[if lt IE 9]>
    <script src="../common/lib/js/html5shiv.js"></script>
    <![endif]-->
</head>

<body>

    <div class="reveal">

        <!-- Any section element inside of this container is displayed as a slide -->
        <div class="slides">

            <!--*************************************************************-->

            <section>
                <h4>NodeSchool Cleveland</h4>
                <h4>October 19, 2015</h4>
                <h2>Promise It Won't Hurt</h2>
                <h6>
                    <small>Thanks to our sponsors</small>
                </h6>
                <div class="flex-row">
                    <span class="flex-item-dynamic">
                        <img src="../common/images/leandog.png"/>
                    </span>
                    <span class="flex-item-dynamic">
                        <img src="../common/images/rockwell.jpg"/>
                    </span>
                </div>
            </section>

            <!--*************************************************************-->

            <section>
                <section data-background="images/welcome.gif">
                    <aside class="notes">
                        <ul>
                            <li>Thanks Lean Dog</li>
                            <li>Restrooms</li>
                            <li>Food and drinks</li>
                            <li>Thanks Rockwell Automation</li>
                            <li>Why are we here?</li>
                            <ul>
                                <li>Pair</li>
                                <li>Help those around you</li>
                            </ul>
                        </ul>
                    </aside>
                </section>

                <section>
                    <p class="center"><small>Tonight's workshopper...</small></p>
                    <h2>Promise It Won't Hurt</h2>

                    <aside class="notes">
                        <ul>
                            <li>Based on surevey results from first meetup</li>
                            <li>More advanced</li>
                            <li>Different format</li>
                            <li>Please interrupt</li>
                        </ul>
                    </aside>
                </section>

            </section>

            <!--*************************************************************-->

            <section>
                <h1>Promises?</h1>
                <section>
                    <aside class="notes">
                        <ul>
                            <li>Popular topic</li>
                            <li>Using Q, not ES6/2015</li>
                            <li>Not a big jump</li>
                        </ul>
                    </aside>
                </section>
                <section>Why Node.js?
                    <aside class="notes">
                        <ul>
                            <li>To understand the role of promises, need to have
                                a fundamental understanding of Node
                            </li>
                        </ul>
                    </aside>
                </section>
            </section>

            <!--*************************************************************-->

            <section>
                <div class="flex-row">
                    <div class="flex-item-dynamic"></div>
                    <span class="flex-item-static">
                        Efficient <br/> Programs
                    </span>
                    <div class="flex-item-dynamic"></div>
                    <span class="flex-item-static">&larr;</span>
                    <div class="flex-item-dynamic"></div>
                    <span class="flex-item-static box">
                        Programming <br/> Environment
                    </span>
                    <div class="flex-item-dynamic"></div>
                    <span class="flex-item-static">&rarr;</span>
                    <div class="flex-item-dynamic"></div>
                    <span class="flex-item-static">
                        Developer <br/> Productivity
                    </span>
                    <div class="flex-item-dynamic"></div>
                </div>
                <aside class="notes">
                    <ol>
                        <li>Programming language/runtime's purpose</li>
                        <li>Fast was not always a priority
                            <ol>
                                <li>No more "free lunch" (2005)</li>
                                <li>Now we leverage multiple cores</li>
                            </ol>
                        </li>
                        <li>Balancing this is hard - many approaches</li>
                    </ol>
                </aside>
            </section>

            <!--*************************************************************-->

            <section>
                <h3>Node's Approach</h3>
                <section>
                    Target the slowest, most difficult parts of a program
                    <aside class="notes">
                        <ul>
                            <li>Identify the costly operations -- I/O</li>
                            <li>Target the costly ones and make them async</li>
                            <li>Dovetail asynchronicity into the rest of the program</li>
                        </ul>
                    </aside>
                </section>
                <section>
                    <table>
                        <tr>
                            <th>Access Type</th><th>Cycles</th>
                        </tr>
                        <tr>
                            <td>L1 Cache</td><td>3</td>
                        </tr>
                        <tr>
                            <td>L2 Cache</td><td>14</td>
                        </tr>
                        <tr>
                            <td>RAM</td><td>250</td>

                        </tr>
                        <tr>
                            <td>Disk</td><td>41 000 000</td>
                        </tr>
                        <tr>
                            <td>Network</td><td>240 000 000</td>
                        </tr>
                    </table>
                    <aside class="notes">
                        <ul>
                            <li>Step 1: ID what programs do.</li>
                            <li>Huge disparity</li>
                            <li>Target the slow operations and make them async</li>
                            <li>Bring asynchronicity back to the programmer in an easy way</li>
                        </ul>
                    </aside>
                </section>
            </section>

            <!--*************************************************************-->

            <section>
                <h3>Possible Solutions</h3>
                <section>
                    <aside class="notes">
                        <ul>
                            <li>Use the right tool for the job</li>
                        </ul>
                    </aside>
                </section>
                <section>Synchronous programming
                    <aside class="notes">
                        <ul>
                            <li>Super easy</li>
                            <li>Super slow</li>
                        </ul>
                    </aside>
                </section>
                <section>Create processes
                    <aside class="notes">
                        <ul>
                            <li>Fairly easy</li>
                            <li>Interprocess communication</li>
                            <li>Does not scale</li>
                        </ul>
                    </aside>
                </section>
                <section>Create threads
                    <aside class="notes">
                        <ul>
                            <li>Lighter than creating processes</li>
                            <li>Memory -- stack (512 kB)</li>
                            <li>Eased using thread pools</li>
                            <li>Thread context switching is prob w/ 10,000 req</li>
                            <li>Difficult -- l ocks, race conditions</li>
                            <li>Apache</li>
                        </ul>
                    </aside>
                </section>
                <section>Event-Driven, non-blocking architecture
                    <aside class="notes">
                        <ul>
                            <li>Node's approach</li>
                            <li>A happy middle ground?</li>
                            <li>Nginx</li>
                        </ul>
                    </aside>
                </section>
            </section>

            <!--*************************************************************-->

            <section>
                <h3>Cut to the Chase</h3>
                <section>

                    1 thread for your code.

                    <aside class="notes">
                        <ul>
                            <li>Little overhead</li>
                            <li>10,000 requests service by 1 thread w/o context switching</li>
                            <li>Developer productivity</li>
                            <li>No concurrency</li>
                            <ul>
                                <li>Not really - child processes, WebWorkers</li>
                            </ul>
                        </ul>
                    </aside>
                </section>
                <section>
                    Node will perform the costly I/O operations using a thread pool.
                    <aside class="notes">
                        <ul>
                            <li>Of no concern to you.</li>
                            <li>Your completion code will just run.</li>
                        </ul>
                    </aside>
                </section>
                <section>
                    <div class="flex-row">
                        <div class="flex-item-dynamic">
                            <p>Recap</p>
                            <ol>
                                <li>Your code will never be interrupted.</li>
                                <li>I/O will  not block</li>
                            </ol>
                        </div>
                        <div class="flex-item-static">
                            <img src="http://i.giphy.com/90F8aUepslB84.gif" alt=""/>
                        </div>
                    </div>
                    <p><small>
                        Source:
                        <a href="http://blog.mixu.net/2011/02/01/understanding-the-node-js-event-loop/">
                            http://blog.mixu.net/2011/02/01/understanding-the-node-js-event-loop/
                        </a>
                    </small></p>
                    <aside class="notes">
                        <ul>
                            <li>Amazingly cool characteristics</li>
                            <li>This is great for web servers</li>
                        </ul>
                    </aside>
                </section>

            </section>

            <!--*************************************************************-->

            <section>
                <section>
                    <h3>So what does this look like?</h3>
                    <aside class="notes">
                        <ul>
                            <li>Node uses callbacks</li>
                            <li>First class functions</li>
                            <li>Closures</li>
                        </ul>
                    </aside>
                </section>
                <section>
                    <h3>Typical Callback Usage</h3>
                    <pre><code data-trim>
var fs = require('fs');

fs.readFile(
    'file1.txt',
    function (err, data) {
        if (err) {throw err;}
        console.log(data);
    }
);
                    </code></pre>
                    <aside class="notes">
                        <ul>
                            <li>Example of using a callback.</li>
                            <li>Typical Node callback argument convention</li>
                            <li>But what happens when there's more than one?</li>
                        </ul>
                    </aside>
                </section>
                <section>
                    <h3>Mulitple Async Operations - Sequential</h3>
                    <pre><code data-trim="">
var fs = require('fs');

fs.readFile(
    'file1.txt',
    function (err, data) {
        if (err) {throw err;}

        fs.readFile(
            'file2.txt',
            function (err, data) {
                if (err) {throw err;}
                console.log(data);
            }
        );
    }
);
                    </code></pre>
                    <aside class="notes">
                        <ul>
                            <li>Error handling is duplicated</li>
                            <li>Big prob: Not concurrent</li>
                            <li>"Pyramid of Doom"</li>
                        </ul>
                    </aside>
                </section>
                <section>
                    <h3>Multiple Async Operations - Concurrently</h3>
                    <pre><code data-trim>
var fs = require('fs'),
    numCompleted = 0,
    onFileRead = function (err, data) {
        if (err) {throw err;}

        numCompleted += 1;
        if (numCompleted === 2) {
            // Both async operation have been completed
        }
    };

fs.readFile('file1.txt', onFileRead);
fs.readFile('file2.txt', onFileRead);
                    </code></pre>
                    <aside class="notes">
                        <p>It is concurrent, but...</p>
                        <ul>
                            <li>Error handling will be difficult</li>
                            <li>Mixing control flow logic with app logic</li>
                            <li>Not composable</li>
                        </ul>
                    </aside>
                </section>
            </section>


            <!--*************************************************************-->

            <section>
                <section>
                    <h3>Promises</h3>
                    <p>
                        A placeholder for a value that may be available in the future.
                    </p>
                    <p>
                        It will be fulfilled or rejected... <em>once!</em>
                    </p>
                    <aside class="notes">
                        <ul>
                            <li>Let's see what this looks like...</li>
                        </ul>
                    </aside>
                </section>
                <section>
                    <h3>Using a promise</h3>
                    <pre><code data-trim>
var file1Promise = readFilePromise('file1.txt');
file1Promise.then(
    function onFulfilled(data) {console.log(data);},
    function onRejected(err) {throw err;}
);
                    </code></pre>
                    <aside class="notes">
                        <ul>
                            <li>You register fulfillment and/or rejection handlers with the promise </li>
                            <li>That's the purpose of then()</li>
                            <li>Called on next turn of event loop</li>
                            <li>Similar to our previous callbacks, actually</li>
                            <li>But now we have file1Promise that can be composed</li>
                            <li>You must understand then()</li>
                        </ul>
                    </aside>
                </section>
            </section>


            <section>
                <section>
                    <pre><code>
var promise1 = readFilePromise('file1.txt');
var wat = promise1.then(
    function onFulfilled(data) { /* ... */ },
    function onRejected(err) { /* ... */ }
);
                    </code></pre>
                    <p>
                        Q: What does then() return? <br/>
                        (What is wat?)
                    </p>
                    <aside class="notes">
                        <ul>
                            <li>I've repeated the basic promise usage here</li>
                            <li>Inserted "wat" variable & assigned it to then()</li>
                            <li>What is wat?</li>
                        </ul>
                    </aside>
                </section>
                <section>
                    <pre><code>
var promise1 = readFilePromise('file1.txt');
var promise2 = promise1.then(
    function onFulfilled(data) { /* ... */ },
    function onRejected(err) { /* ... */ }
);
                    </code></pre>
                    <p>
                        Q: What does then() return?
                    </p>
                    <p>
                        A: A promise
                    </p>

                    <aside class="notes">
                        <ul>
                            <li>then() is a <b>promise</b> method that gives you a <b>promise</b></li>
                            <li>This allows chaining</li>
                            <li>then().then().then() ...</li>
                            <li>The promise you get depends on what your handlers do</li>
                            <li>...</li>
                        </ul>
                    </aside>
                </section>
            </section>

            <!--*************************************************************-->

            <section>
                <pre><code>
var promise1 = readFilePromise('file1.txt');
var promise2 = promise1.then(
    function onFulfilled(data) { /* ... */ },
    function onRejected(err) { /* ... */ }
);
                    </code></pre>
                <p>1 of 3 things can happen in your handlers:</p>
                <ol>
                    <li class="fragment">
                        Return a value <br/>
                        then() will return a <b>promise</b> that has been fulfilled with that value.
                    </li>
                    <li class="fragment">
                        Throw an exception <br/>
                        then() will return a <b>promise</b> that has been rejected with that exception.
                    </li>
                    <li class="fragment">
                        Return a promise <br/>
                        then() will return that <b>promise</b>.
                    </li>
                </ol>
                <aside class="notes">
                    <ul>
                        <li>I've created a varible "promise2" to hold the output of then()</li>
                    </ul>
                </aside>
            </section>

            <!--*************************************************************-->

            <section>
                <h3>Reading 2 files sequentially</h3>
                <pre><code data-trim="">
readFilePromise('file1.txt').then(
    function onFulfilled(data) {
        console.log(data);
        return readFilePromise('file2.txt');
    }
).then(
    function onFulfilled(data) {console.log(data);}
).catch(
    function onRejected(err) {throw err;}
);
                </code></pre>
            </section>

            <!--*************************************************************-->

            <section>
                <h3>Reading 2 files concurrently</h3>
                    <pre><code data-trim="">
var q = require('q'),
    aggregatePromise,
    thePromises = [readFilePromise('file1.txt'), readFilePromise('file2.txt')];

aggregatePromise = q.all(thePromises);
aggregatePromise.then(
    function (values) {
        // values[0] is file1.txt data
        // values[1] is file2.txt data
    }
).catch(function onRejected(err) {throw err;});
                    </code></pre>
            </section>

            <!--*************************************************************-->

            <section>
                <h3>Converting from Callbacks to Promises</h3>
                <pre><code data-trim>
var fs = require('fs'),
    q = require('q');

function promiseReadFile(fileName) {
    var dfd = q.defer();

    fs.readFile(fileName, function (err, data) {
        if (err)
        {
            dfd.reject(err);
            return;
        }

        dfd.resolve(data);
    });

    return dfd.promise;
}
                </code></pre>
                <aside class="notes">
                    <ul>
                        <li>If your code is going to use promises, it's nice if all of it uses promises</li>
                        <li>Node still has callbacks</li>
                        <li>This is not the ES6 promises way.</li>
                        <li>Top - bottom - middle</li>
                        <li>This is how you will create a promise in the first couple
                            of exercises.
                        </li>
                    </ul>
                </aside>
            </section>

            <!--*************************************************************-->

            <section>
                <h3>We're Just Scratching the Surface</h3>

                <ul>
                    <li><code>promise.spread()</code></li>
                    <li><code>promise.allSettled()</code></li>
                    <li><code>promise.any()</code></li>
                    <li><code>promise.race()</code></li>
                    <li><code>promise.finally()</code></li>
                    <li>etc. etc. etc.</li>
                </ul>

            </section>

            <!--*************************************************************-->

            <section>
                <h3>Let's get started</h3>

                    <p>To get setup:</p>
                    <pre><code>
$ mkdir promise-it-wont-hurt && cd promise-it-wont-hurt
$ npm install q
$ npm install -g promise-it-wont-hurt@latest
                    </code></pre>

                <p>
                    To run: <code></code>
                </p>
                <pre><code>
$ promise-it-wont-hurt
$ promise-it-wont-hurt run program.js
$ promise-it-wont-hurt verfiy program.js
                </code></pre>

                <p>
                    This presentation: <br/>
                    <a href="http://bit.ly/nsclepresentations">http://bit.ly/nsclepresentations</a>
                </p>
            </section>

            <!--*************************************************************-->

            <section>
                <h1>Thank You!</h1>
                <div class="flex-row">
                    <span class="flex-item-dynamic">
                        <img src="../common/images/leandog.png"/>
                    </span>
                    <span class="flex-item-dynamic">
                        <img src="../common/images/rockwell.jpg"/>
                    </span>
                </div>
            </section>

        </div>
    </div>


    <!--
    Example: How to do a terminal window
    <div class="terminal">
        <div class="terminal-title">terminal - 86 x 29</div>
        <div class="terminal-text type-text" title="npm init \n npm install &#45;&#45;save q \n npm install -g promise-it-wont-hurt \n"></div>
    </div>-->

    <!--*************************************************************-->

    <!--
    An example of using the Repl plugin:
    -->

    <!--
    <section>
        <pre><code class="eval language-javascript" contenteditable>
function longOperation () {
var delay = 3 * 1000,
dfd = Q.defer();

setTimeout(
function () {
    dfd.resolve(delay);
}, delay);

return dfd.promise;
}

var promise = longOperation();
promise.then(
function (value) {
alert('Resolved with value=' + value);
});
        </code></pre>
        <pre><code class="echo language-javascript"> </code></pre>
    </section>
    -->


    <script src="../common/lib/js/head.min.js"></script>
    <script src="../common/js/reveal.js"></script>

    <script src="../common/js/jquery-1.11.3.min.js"></script>
    <script src="../common/js/jquery.teletype.min.js"></script>
    <script src="../common/js/q.js"></script>

    <script>
        /*

         $( function() {
         $( '.type-text' ).each( function() {
         var items = $( this ).text();
         $( this ).empty().attr( 'title', '' ).teletype( {
         text: $.map( items.split( ';' ), $.trim ), // List of strings to output.
         typeDelay: 10, // Minimum delay, in ms, between typing characters.
         backDelay: 20, // Minimum delay, in ms, between deleting characters.
         blinkSpeed: 1000, // Interval, in ms, that the cursor will flash.
         cursor: '▋', // Character used to represent the cursor.
         delay: 3000, // Time in ms to pause before deleting the current text.
         preserve: false, // Prevent auto delete of the current string and begin outputting the next string.
         prefix: '$ ', // Begin each string with this prefix value.
         loop: 0, // Number of times to loop through the output strings, for unlimited use 0.
         humanise: true // Add a random delay before each character to represent human interaction.
         } );
         } );
         } );

         */

        Reveal.addEventListener(
                'slidechanged', function (event) {
                    // event.previousSlide, event.currentSlide, event.indexh, event.indexv
                    $(event.currentSlide).find(".type-text").each(
                            function () {
                                var items = $(this).attr('title');
                                $(this).empty().teletype(
                                        {
                                            text:       $.map(
                                                    items.split(';'), $.trim), // List of strings to output.
                                            typeDelay:  40, // Minimum delay, in ms, between typing characters.
                                            backDelay:  20, // Minimum delay, in ms, between deleting characters.
                                            blinkSpeed: 1000, // Interval, in ms, that the cursor will flash.
                                            cursor:     '▋', // Character used to represent the cursor.
                                            delay:      3000, // Time in ms to pause before deleting the current text.
                                            preserve:   true, // Prevent auto delete of the current string and begin outputting the next string.
                                            prefix:     '$ ', // Begin each string with this prefix value.
                                            loop:       1, // Number of times to loop through the output strings, for unlimited use 0.
                                            humanise:   true // Add a random delay before each character to represent human interaction.
                                        });
                            });

                });

        // Full list of configuration options available at:
        // https://github.com/hakimel/reveal.js#configuration
        Reveal.initialize(
                {
                    //width: 1920,
                    //height: 958,

                    controls: true,
                    progress: true,
                    history:  true,
                    center:   true,

                    transition: 'slide', // none/fade/slide/convex/concave/zoom

                    // Optional reveal.js plugins
                    dependencies: [
                        {
                            src:       'lib/js/classList.js',
                            condition: function () { return !document.body.classList; }
                        },
                        {
                            src:       '../common/plugin/markdown/marked.js',
                            condition: function () { return !!document.querySelector('[data-markdown]'); }
                        },
                        {
                            src:       '../common/plugin/markdown/markdown.js',
                            condition: function () { return !!document.querySelector('[data-markdown]'); }
                        },
                        {
                            src:       '../common/plugin/highlight/highlight.js',
                            async:     true,
                            condition: function () { return !!document.querySelector('pre code'); },
                            callback:  function () { hljs.initHighlightingOnLoad(); }
                        },
                        {
                            src:   '../common/plugin/zoom-js/zoom.js',
                            async: true
                        },
                        {
                            src:   '../common/plugin/notes/notes.js',
                            async: true
                        },
                        {
                            src:   '../common/plugin/repl/repl.js',
                            async: true,
                            condition: function () { return !!document.querySelector('pre code.eval'); }
                        }
                    ]
                });

        Reveal.configure(
                {
                    slideNumber: true
                }
        );

    </script>

</body>
</html>
